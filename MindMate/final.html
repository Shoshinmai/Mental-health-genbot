<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMate - Mental Health Support</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header styles */
        header {
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo-icon {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
        }
        
        .logo-text {
            margin-left: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .emergency-btn {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            white-space: nowrap;
            cursor: pointer;
            border: none;
        }
        
        .emergency-btn:hover {
            background-color: #fecaca;
        }
        
        .camera-toggle {
            display: flex;
            align-items: center;
            background-color: #f3f4f6;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
        }
        
        .camera-toggle-text {
            font-size: 0.875rem;
            color: #4b5563;
            margin-right: 0.5rem;
        }
        
        .toggle-btn {
            position: relative;
            width: 3rem;
            height: 1.5rem;
            transition: background-color 0.2s ease-in-out;
            border-radius: 9999px;
            cursor: pointer;
            outline: none;
        }
        
        .toggle-btn:focus {
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        
        .toggle-btn-on {
            background-color: #4f46e5;
        }
        
        .toggle-btn-off {
            background-color: #d1d5db;
        }
        
        .toggle-knob {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.2s ease-in-out;
            background-color: white;
            border-radius: 9999px;
            position: absolute;
            top: 0.125rem;
        }
        
        .toggle-knob-on {
            transform: translateX(1.5rem);
        }
        
        .toggle-knob-off {
            transform: translateX(0.125rem);
        }
        
        .user-avatar {
            width: 2rem;
            height: 2rem;
            background-color: #e0e7ff;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* Main layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar styles */
        .sidebar {
            display: none;
            width: 20rem;
            background-color: white;
            border-right: 1px solid #e5e7eb;
            padding: 1.25rem;
            overflow-y: auto;
        }
        
        @media (min-width: 768px) {
            .sidebar {
                display: block;
            }
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        
        .mood-card {
            background-color: #eef2ff;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .mood-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .mood-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: #e0e7ff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mood-info {
            margin-left: 0.75rem;
        }
        
        .mood-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #1f2937;
        }
        
        .mood-status {
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .chart-container {
            height: 10rem;
        }
        
        .activity-item {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .activity-item:hover {
            background-color: #f9fafb;
        }
        
        .activity-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .activity-text {
            margin-left: 0.75rem;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .resource-link {
            display: block;
            font-size: 0.875rem;
            color: #4b5563;
            transition: color 0.2s;
            text-decoration: none;
            margin-bottom: 0.5rem;
        }
        
        .resource-link:hover {
            color: #4f46e5;
        }
        
        /* Chat area styles */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f9fafb;
            overflow: hidden;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .messages-inner {
            max-width: 48rem;
            margin: 0 auto;
        }
        
        .camera-permission-banner {
            background-color: #eef2ff;
            border: 1px solid #c7d2fe;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .banner-content {
            display: flex;
        }
        
        .banner-icon {
            flex-shrink: 0;
            color: #4f46e5;
        }
        
        .banner-text {
            margin-left: 0.75rem;
        }
        
        .banner-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #3730a3;
        }
        
        .banner-description {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #4338ca;
        }
        
        .banner-actions {
            margin-top: 1rem;
        }
        
        .btn-primary {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            background-color: #4f46e5;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background-color: #4338ca;
        }
        
        .btn-secondary {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #f9fafb;
        }
        
        .message {
            display: flex;
            margin-bottom: 1rem;
        }
        
        .message-user {
            justify-content: flex-end;
        }
        
        .message-ai {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 28rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        .message-bubble-user {
            background-color: #4f46e5;
            color: white;
        }
        
        .message-bubble-ai {
            background-color: white;
            border: 1px solid #e5e7eb;
            color: #1f2937;
        }
        
        .message-time {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .message-time-user {
            color: #a5b4fc;
        }
        
        .message-time-ai {
            color: #6b7280;
        }
        
        .typing-indicator {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 1rem;
        }
        
        .typing-bubble {
            background-color: white;
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            max-width: 28rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: #9ca3af;
            border-radius: 9999px;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-0.25rem);
            }
        }
        
        /* Input area styles */
        .input-area {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
        }
        
        .input-inner {
            max-width: 48rem;
            margin: 0 auto;
        }
        
        .message-form {
            display: flex;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            min-width: 0;
        }
        
        .message-input input {
            display: block;
            width: 100%;
            border: none;
            background-color: #f3f4f6;
            border-radius: 9999px;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #111827;
        }
        
        .message-input input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        
        .send-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: #4f46e5;
            color: white;
            border: none;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-left: 0.75rem;
        }
        
        .send-btn:hover {
            background-color: #4338ca;
        }
        
        .privacy-notice {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
        }
        
        /* Camera feed styles */
        .camera-feed {
            position: fixed;
            bottom: 5rem;
            right: 1.5rem;
            width: 16rem;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            background-color: white;
            z-index: 10;
        }
        
        .camera-header {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .camera-title {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .camera-title i {
            margin-right: 0.5rem;
        }
        
        .camera-close {
            color: white;
            transition: color 0.2s;
            cursor: pointer;
        }
        
        .camera-close:hover {
            color: #a5b4fc;
        }
        
        .camera-video {
            position: relative;
        }
        
        .camera-video video {
            width: 100%;
            height: 12rem;
            object-fit: cover;
        }
        
        .emotion-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal {
            background-color: white;
            border-radius: 0.5rem;
            max-width: 28rem;
            width: 100%;
            padding: 1.5rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            color: #9ca3af;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #6b7280;
        }
        
        .warning-banner {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .warning-content {
            display: flex;
        }
        
        .warning-icon {
            flex-shrink: 0;
            color: #dc2626;
        }
        
        .warning-text {
            margin-left: 0.75rem;
            font-size: 0.875rem;
            color: #b91c1c;
        }
        
        .resource-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .resource-title {
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.5rem;
        }
        
        .resource-description {
            color: #6b7280;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .resource-phone {
            display: flex;
            align-items: center;
            color: #4f46e5;
            font-weight: 500;
            text-decoration: none;
        }
        
        .resource-phone:hover {
            color: #3730a3;
        }
        
        .resource-phone i {
            margin-right: 0.5rem;
        }
        
        .modal-footer {
            margin-top: 1.5rem;
        }
        
        .modal-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            background-color: #4f46e5;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .modal-btn:hover {
            background-color: #4338ca;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-brain"></i>
            </div>
            <h1 class="logo-text">MindMate</h1>
        </div>
        <div class="header-actions">
            <button id="emergencyBtn" class="emergency-btn">
                <i class="fas fa-phone-alt mr-2"></i>
                <span>Emergency Resources</span>
            </button>
            <div class="camera-toggle">
                <span class="camera-toggle-text">Camera</span>
                <button id="cameraToggleBtn" class="toggle-btn toggle-btn-off">
                    <span class="toggle-knob toggle-knob-off"></span>
                </button>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user text-indigo-600"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h2 class="sidebar-title">Your Dashboard</h2>
                <div class="mood-card">
                    <div class="mood-header">
                        <div class="mood-icon">
                            <i class="fas fa-smile text-indigo-600"></i>
                        </div>
                        <div class="mood-info">
                            <h3 class="mood-title">Current Mood</h3>
                            <p class="mood-status" id="currentMood">Feeling neutral</p>
                        </div>
                    </div>
                    <div class="chart-container" id="moodChart"></div>
                </div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">Recommended Activities</h3>
                <div class="space-y-3">
                    <div class="activity-item">
                        <div class="activity-icon bg-blue-100">
                            <i class="fas fa-lungs text-blue-600"></i>
                        </div>
                        <span class="activity-text">Breathing Exercise</span>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon bg-green-100">
                            <i class="fas fa-book text-green-600"></i>
                        </div>
                        <span class="activity-text">Guided Journal</span>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon bg-purple-100">
                            <i class="fas fa-moon text-purple-600"></i>
                        </div>
                        <span class="activity-text">Sleep Meditation</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">Resources</h3>
                <div class="space-y-2">
                    <a href="#" class="resource-link">Mental Health Articles</a>
                    <a href="#" class="resource-link">Find a Therapist</a>
                    <a href="#" class="resource-link">Community Support</a>
                    <a href="#" class="resource-link">Privacy Settings</a>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <!-- Chat Messages -->
            <div class="messages-container">
                <div class="messages-inner">
                    <div id="cameraPermissionBanner" class="camera-permission-banner">
                        <div class="banner-content">
                            <div class="banner-icon">
                                <i class="fas fa-camera text-indigo-500"></i>
                            </div>
                            <div class="banner-text">
                                <h3 class="banner-title">Camera Access</h3>
                                <div class="banner-description">
                                    <p>MindMate can use your camera for emotion-aware support. This is optional and will not be stored.</p>
                                </div>
                                <div class="banner-actions">
                                    <button id="enableCameraBtn" class="btn-primary">
                                        Enable Camera
                                    </button>
                                    <button id="dismissCameraBtn" class="btn-secondary ml-3">
                                        Not Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="messagesContainer">
                        <!-- Messages will be inserted here by JavaScript -->
                        <div class="message message-ai">
                            <div class="message-bubble message-bubble-ai">
                                <div class="message-text">Hello! I'm MindMate, your mental health support companion. How are you feeling today?</div>
                                <div class="message-time message-time-ai" id="initialMessageTime"></div>
                            </div>
                        </div>
                    </div>
                    <div id="messagesEnd"></div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="input-area">
                <div class="input-inner">
                    <form id="messageForm" class="message-form">
                        <div class="message-input">
                            <input type="text" id="messageInput" placeholder="Type your message here...">
                        </div>
                        <button type="submit" class="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div class="privacy-notice">
                        All messages are end-to-end encrypted. MindMate is not a substitute for professional therapy.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Feed (if enabled) -->
    <div id="cameraFeed" class="camera-feed" style="display: none;">
        <div class="camera-header">
            <div class="camera-title">
                <i class="fas fa-video"></i>
                <span>Camera Feed</span>
            </div>
            <div>
                <button id="closeCameraBtn" class="camera-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="camera-video">
            <video id="cameraVideo" autoplay playsinline muted></video>
            <div id="emotionLabel" class="emotion-label" style="display: none;">Detected: neutral</div>
        </div>
    </div>

    <!-- Emergency Resources Modal -->
    <div id="emergencyModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Emergency Resources</h2>
                <button id="closeModalBtn" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="warning-banner">
                    <div class="warning-content">
                        <div class="warning-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="warning-text">
                            <p>
                                If you're experiencing a life-threatening emergency, please call emergency services immediately.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="resource-card">
                    <h3 class="resource-title">National Suicide Prevention Lifeline</h3>
                    <p class="resource-description">24/7, free and confidential support for people in distress.</p>
                    <a href="tel:1-800-273-8255" class="resource-phone">
                        <i class="fas fa-phone-alt"></i>
                        1-800-273-8255
                    </a>
                </div>
                <div class="resource-card">
                    <h3 class="resource-title">Crisis Text Line</h3>
                    <p class="resource-description">Text with a trained crisis counselor.</p>
                    <p class="resource-phone">Text HOME to 741741</p>
                </div>
                <div class="resource-card">
                    <h3 class="resource-title">SAMHSA's National Helpline</h3>
                    <p class="resource-description">Treatment referral and information service.</p>
                    <a href="tel:1-800-662-4357" class="resource-phone">
                        <i class="fas fa-phone-alt"></i>
                        1-800-662-HELP (4357)
                    </a>
                </div>
                <div class="resource-card">
                    <h3 class="resource-title">Veterans Crisis Line</h3>
                    <p class="resource-description">For U.S. Military Veterans and their loved ones.</p>
                    <a href="tel:1-800-273-8255" class="resource-phone">
                        <i class="fas fa-phone-alt"></i>
                        1-800-273-8255 (Press 1)
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeModalBtn2" class="modal-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize state
        const state = {
            messages: [
                {
                    id: 1,
                    text: "Hello! I'm MindMate, your mental health support companion. How are you feeling today?",
                    sender: 'ai',
                    timestamp: new Date(Date.now() - 60000)
                }
            ],
            isTyping: false,
            cameraEnabled: false,
            cameraPermissionAsked: false,
            currentEmotion: null,
            showEmergencyResources: false
        };

        // DOM elements
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messagesEnd: document.getElementById('messagesEnd'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            cameraToggleBtn: document.getElementById('cameraToggleBtn'),
            cameraPermissionBanner: document.getElementById('cameraPermissionBanner'),
            enableCameraBtn: document.getElementById('enableCameraBtn'),
            dismissCameraBtn: document.getElementById('dismissCameraBtn'),
            cameraFeed: document.getElementById('cameraFeed'),
            cameraVideo: document.getElementById('cameraVideo'),
            closeCameraBtn: document.getElementById('closeCameraBtn'),
            emotionLabel: document.getElementById('emotionLabel'),
            currentMood: document.getElementById('currentMood'),
            emergencyBtn: document.getElementById('emergencyBtn'),
            emergencyModal: document.getElementById('emergencyModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            closeModalBtn2: document.getElementById('closeModalBtn2'),
            initialMessageTime: document.getElementById('initialMessageTime')
        };

        // Initialize mood chart
        function initMoodChart() {
            const chart = echarts.init(document.getElementById('moodChart'));
            const option = {
                animation: false,
                title: {
                    text: 'Your Mood Trends',
                    left: 'center',
                    textStyle: {
                        fontSize: 14,
                        fontWeight: 'normal'
                    }
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    axisLine: {
                        lineStyle: {
                            color: '#ddd'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    min: 0,
                    max: 10,
                    name: 'Mood Score',
                    nameTextStyle: {
                        padding: [0, 0, 0, 40]
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#ddd'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f5f5f5'
                        }
                    }
                },
                series: [
                    {
                        data: [5.2, 6.5, 4.8, 7.3, 6.8, 7.1, 8.2],
                        type: 'line',
                        smooth: true,
                        symbol: 'circle',
                        symbolSize: 8,
                        lineStyle: {
                            width: 3,
                            color: '#6366f1'
                        },
                        itemStyle: {
                            color: '#6366f1'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [
                                    {
                                        offset: 0,
                                        color: 'rgba(99, 102, 241, 0.3)'
                                    },
                                    {
                                        offset: 1,
                                        color: 'rgba(99, 102, 241, 0.05)'
                                    }
                                ]
                            }
                        }
                    }
                ],
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%'
                }
            };
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Scroll to bottom of messages
        function scrollToBottom() {
            elements.messagesEnd.scrollIntoView({ behavior: 'smooth' });
        }

        // Add message to chat
        function addMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message message-${message.sender}`;
            
            const bubbleClass = `message-bubble message-bubble-${message.sender}`;
            const timeClass = `message-time message-time-${message.sender}`;
            
            messageElement.innerHTML = `
                <div class="${bubbleClass}">
                    <div class="message-text">${message.text}</div>
                    <div class="${timeClass}">${formatTime(message.timestamp)}</div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(messageElement);
            scrollToBottom();
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.className = 'typing-indicator';
            typingElement.innerHTML = `
                <div class="typing-bubble">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            elements.messagesContainer.appendChild(typingElement);
            scrollToBottom();
            
            return typingElement;
        }

        // Remove typing indicator
        function removeTypingIndicator(typingElement) {
            if (typingElement && typingElement.parentNode) {
                typingElement.parentNode.removeChild(typingElement);
            }
        }

        // Get AI response
        function getAIResponse(message, emotion) {
            const lowercaseMsg = message.toLowerCase();
            
            if (lowercaseMsg.includes('sad') || emotion === 'sad') {
                return "I'm sorry to hear you're feeling down. Remember that it's okay to feel this way sometimes. Would you like to talk about what's troubling you?";
            } else if (lowercaseMsg.includes('anxious') || lowercaseMsg.includes('anxiety') || emotion === 'anxious') {
                return "Anxiety can be challenging to deal with. Let's take a moment to breathe together. In through your nose for 4 counts, hold for 2, and out through your mouth for 6. Would you like to try some grounding exercises?";
            } else if (lowercaseMsg.includes('happy') || emotion === 'happy') {
                return "It's wonderful to hear you're feeling good! What's contributing to your positive mood today?";
            } else if (lowercaseMsg.includes('help') || lowercaseMsg.includes('emergency')) {
                return "If you're experiencing a crisis, please consider reaching out to a professional immediately. I've opened our emergency resources for you.";
            } else {
                return "Thank you for sharing. How does that make you feel? Remember, I'm here to listen and support you, but I'm not a substitute for professional therapy.";
            }
        }

        // Handle send message
        function handleSendMessage() {
            const messageText = elements.messageInput.value.trim();
            if (messageText === '') return;
            
            // Add user message
            const userMessage = {
                id: state.messages.length + 1,
                text: messageText,
                sender: 'user',
                timestamp: new Date()
            };
            
            state.messages.push(userMessage);
            addMessage(userMessage);
            
            elements.messageInput.value = '';
            state.isTyping = true;
            
            // Show typing indicator
            const typingElement = showTypingIndicator();
            
            // Simulate AI response after a delay
            setTimeout(() => {
                const aiResponse = {
                    id: state.messages.length + 2,
                    text: getAIResponse(messageText, state.currentEmotion),
                    sender: 'ai',
                    timestamp: new Date()
                };
                
                state.messages.push(aiResponse);
                removeTypingIndicator(typingElement);
                addMessage(aiResponse);
                state.isTyping = false;
                
                // Show emergency resources if needed
                if (aiResponse.text.includes('emergency resources')) {
                    toggleEmergencyModal(true);
                }
            }, 1500);
        }

        // Toggle camera
        async function toggleCamera() {
            if (!state.cameraPermissionAsked) {
                state.cameraPermissionAsked = true;
                elements.cameraPermissionBanner.style.display = 'none';
            }
            
            if (state.cameraEnabled) {
                // Disable camera
                if (elements.cameraVideo.srcObject) {
                    const tracks = elements.cameraVideo.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    elements.cameraVideo.srcObject = null;
                }
                
                state.cameraEnabled = false;
                state.currentEmotion = null;
                elements.cameraFeed.style.display = 'none';
                elements.emotionLabel.style.display = 'none';
                elements.currentMood.textContent = 'Feeling neutral';
                
                // Update toggle button
                elements.cameraToggleBtn.classList.remove('toggle-btn-on');
                elements.cameraToggleBtn.classList.add('toggle-btn-off');
                elements.cameraToggleBtn.querySelector('.toggle-knob').classList.remove('toggle-knob-on');
                elements.cameraToggleBtn.querySelector('.toggle-knob').classList.add('toggle-knob-off');
            } else {
                // Enable camera
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    elements.cameraVideo.srcObject = stream;
                    state.cameraEnabled = true;
                    elements.cameraFeed.style.display = 'block';
                    
                    // Update toggle button
                    elements.cameraToggleBtn.classList.remove('toggle-btn-off');
                    elements.cameraToggleBtn.classList.add('toggle-btn-on');
                    elements.cameraToggleBtn.querySelector('.toggle-knob').classList.remove('toggle-knob-off');
                    elements.cameraToggleBtn.querySelector('.toggle-knob').classList.add('toggle-knob-on');
                    
                    // Simulate emotion detection
                    const emotions = ['neutral', 'happy', 'sad', 'anxious', 'surprised'];
                    const randomEmotion = emotions[Math.floor(Math.random() * emotions.length)];
                    state.currentEmotion = randomEmotion;
                    
                    elements.emotionLabel.textContent = `Detected: ${randomEmotion}`;
                    elements.emotionLabel.style.display = 'block';
                    elements.currentMood.textContent = `Feeling ${randomEmotion}`;
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Could not access your camera. Please check your permissions.");
                }
            }
        }

        // Toggle emergency resources modal
        function toggleEmergencyModal(show) {
            state.showEmergencyResources = show;
            elements.emergencyModal.style.display = show ? 'flex' : 'none';
        }

        // Event listeners
        elements.messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleSendMessage();
        });

        elements.messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });

        elements.cameraToggleBtn.addEventListener('click', toggleCamera);
        elements.enableCameraBtn.addEventListener('click', toggleCamera);
        elements.dismissCameraBtn.addEventListener('click', function() {
            state.cameraPermissionAsked = true;
            elements.cameraPermissionBanner.style.display = 'none';
        });
        elements.closeCameraBtn.addEventListener('click', toggleCamera);
        elements.emergencyBtn.addEventListener('click', function() {
            toggleEmergencyModal(true);
        });
        elements.closeModalBtn.addEventListener('click', function() {
            toggleEmergencyModal(false);
        });
        elements.closeModalBtn2.addEventListener('click', function() {
            toggleEmergencyModal(false);
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initMoodChart();
            elements.initialMessageTime.textContent = formatTime(state.messages[0].timestamp);
            
            // Add initial message
            if (state.messages.length > 0) {
                addMessage(state.messages[0]);
            }
        });
    </script>
</body>
</html>